---
title: "GLODAPv2_2020"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r define_updata_paths}
path_glodapv2_2020  <- "/nfs/kryo/work/updata/glodapv2_2020/"
path_preprocessing  <- "/nfs/kryo/work/updata/emlr_cant/observations/preprocessing/"
```


```{r parent, child = "/nfs/kryo/work/updata/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

# Libraries

Loading libraries specific to the the analysis performed in this section.

```{r load_libraries_specific, message=FALSE, warning=FALSE}
library(lubridate)
```


# Read files

Main data source for this project is `GLODAPv2.2020_Merged_Master_File.csv` downloaded from [glodap.info](https://www.glodap.info/){target="_blank"} in June 2020.

```{r read_GLODAPv2_2020_merged_master_file}

GLODAP <-
  read_csv(
    paste(
      path_glodapv2_2020,
      "GLODAPv2.2020_Merged_Master_File.csv",
      sep = ""
    ),
    na = "-9999",
    col_types = cols(.default = col_double())
    )

```

```{r harmonize_variables}

# select relevant columns
GLODAP <- GLODAP %>%
  select(cruise:talkqc)

# create date column
GLODAP <- GLODAP %>%
  mutate(date = ymd(paste(year, month, day))) %>%
  relocate(date)

# harmonize column names
GLODAP <- GLODAP  %>%
  rename(sal = salinity,
         tem = temperature)

# harmonize coordinates
GLODAP <- GLODAP  %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# remove irrelevant columns
GLODAP <- GLODAP %>%
  select(-c(month:minute,
            maxsampdepth, bottle, sigma0:sigma4,
            nitrite:nitritef))

```

# Data preparation

## Subset tco2 data

The vast majority of rows is removed due to missing tco2 observations.

```{r tco2_na_subset}

GLODAP <- GLODAP %>% 
  filter(!is.na(tco2))

```

## Horizontal gridding

For merging with other data sets, all observations were grouped into latitude intervals of:

- 1° x 1°

```{r grid_spatially_1x1}

GLODAP <- m_grid_horizontal(GLODAP)

```


## Basin mask

The basin mask from the World Ocean Atlas was used. For details consult the data base subsection for [WOA18](https://jens-daniel-mueller.github.io/Cant_eMLR/read_World_Ocean_Atlas_2018.html) data.

Please note that some GLODAP observations were made outside the WOA18 basin mask (i.e. in marginal seas) and will be removed for further analysis.

```{r join_GLODAP_basin_mask}

# use only data inside basinmask
GLODAP <- inner_join(GLODAP, basinmask)

```

## Create clean observations grid

```{r create_clean_obs_grid}

GLODAP_obs_grid <- GLODAP %>% 
  count(lat, lon)

```

## Write summary file
 
```{r write_clean_data_files}

GLODAP  %>%  write_csv(paste(path_preprocessing,
                             "GLODAPv2.2020_clean.csv",
                             sep = ""))

```


# Overview plots

## Assign coarse spatial grid

For the following plots, the cleaned data set was re-opened and observations were gridded spatially to intervals of:  

- 5° x 5°

```{r grid_spatially_5x5}

GLODAP <- m_grid_horizontal_coarse(GLODAP)

```


## Histogram Zonal coverage

```{r coverage_histogram_zonal}

GLODAP_histogram_lat <- GLODAP %>%
  group_by(lat_grid, basin) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_lat %>%
  ggplot(aes(lat_grid, n)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ basin) +
  theme(legend.title = element_blank())

rm(GLODAP_histogram_lat)

```

## Histogram temporal coverage

```{r coverage_histogram_temporal}

GLODAP_histogram_year <- GLODAP %>%
  group_by(year, basin) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_year %>%
  ggplot() +
  geom_col(aes(year, n)) +
  facet_wrap(~ basin, ncol = 1) +
  theme(
    axis.title.x = element_blank()
  )

rm(GLODAP_histogram_year)

```

## Zonal temporal coverage (Hovmoeller)

```{r coverage_hovmoeller, fig.asp=1}

GLODAP_hovmoeller_year <- GLODAP %>%
  group_by(year, lat_grid, basin) %>%
  tally() %>%
  ungroup()

GLODAP_hovmoeller_year %>%
  ggplot(aes(year, lat_grid, fill = log10(n))) +
  geom_tile() +
  geom_vline(xintercept = c(1999.5, 2012.5)) +
  scale_fill_viridis_c(option = "magma", direction = -1) +
  facet_wrap( ~ basin, ncol = 1) +
  theme(legend.position = "top",
        axis.title.x = element_blank())

rm(GLODAP_hovmoeller_year)

```

## Coverage map

```{r coverage_maps_era_subsetting}

map +
  geom_raster(data = GLODAP_obs_grid,
              aes(lon, lat, fill = log10(n))) +
  scale_fill_viridis_c(option = "magma",
                       direction = -1)

```

# Exploratory data analysis

```{r EDA_GLODAP_clean, eval=FALSE}

source(paste(path_functions,
             "eda.R",
             sep = ""))

eda(GLODAP, "GLODAPv2_2020_preprocessed")
rm(eda)

```

The output of an automated Exploratory Data Analysis (EDA) performed with the package `DataExplorer` can be accessed here:

[Link to EDA report of GLODAPv2_2020 raw data](https://jens-daniel-mueller.github.io/Cant_eMLR/EDA_report_GLODAPv2_2020_preprocessed.html){target="_blank}
