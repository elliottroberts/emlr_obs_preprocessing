---
title: "GLODAPv2_2020"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths}

path_glodapv2_2021  <- "/nfs/kryo/work/updata/glodapv2_2021/"
path_glodapv2_CRM  <- "/nfs/kryo/work/updata/glodapv2_CRM/"
path_crossover <- "/nfs/kryo/work/updata/glodapv2_crossover"

path_preprocessing  <- paste(path_root, "/observations/preprocessing/", sep = "")
```

```{r load_libraries_specific, include=FALSE}
library(lubridate)
library(ggrepel)
library(kableExtra)
```

# Read files

## Adjusted data

Main data source for this project is `GLODAPv2.2021_Merged_Master_File.csv` downloaded from `https://www.ncei.noaa.gov/data/oceans/ncei/ocads/data/0237935/GLODAPv2.2021_Merged_Master_File.csv` on Aug 30, 2021.

```{r read_GLODAPv2_2021_merged_master_file}

GLODAP <-
  read_csv(
    paste(
      path_glodapv2_2021,
      "GLODAPv2.2021_Merged_Master_File_20210830.csv",
      sep = ""
    ),
    na = "-9999",
    col_types = cols(.default = col_double())
  )


GLODAP <- GLODAP %>%
  rename_with(~str_remove(., 'G2'))

```

## Adjustment table

```{r read_GLODAPv2_2021_adjustment_table}

GLODAP_adjustments <-
  read_csv(
    paste(
      path_glodapv2_2021,
      "GLODAPv2.2021_adjustments_last_updated_on_2021_05_10.csv",
      sep = ""
    ),
    na = c("-666", "-777", "-888", "-999"),
    skip = 2
  )

```

## Expocodes

```{r read_GLODAPv2_2021_expocodes_and_doi}

GLODAP_expocodes <-
  read_tsv(
    paste(
      path_glodapv2_2021,
      "EXPOCODES.txt",
      sep = ""
    ),
    col_names = c("cruise", "cruise_expocode")
  )

```

## Crossover tables

```{r read_crossover_tables}

# tables from glodapv2, provided by Steven van Heuven

glodapv2_xover_files <- fs::dir_ls(paste0(path_crossover, "/glodapv2"))

glodapv2_xover <- glodapv2_xover_files %>% 
  map_dfr(read_csv, .id = "parameter")

glodapv2_xover <- glodapv2_xover %>% 
  mutate(parameter = str_remove(parameter, ".csv"),
         parameter = str_sub(parameter, -3))


glodapv2_xover <- glodapv2_xover %>% 
  mutate(parameter = recode(parameter,
                            "ALK" = "talk",
                            "DIC" = "tco2",
                            "NO3" = "nitrate",
                            "_O2" = "oxygen",
                            "PO4" = "phosphate",
                            "SAL" = "salinity",
                            "SIL" = "silicate"))

# Note: In the files provided by Steven von Heuven
# the column names sigma_ratio and sigma_offset_sd were swapped

glodapv2_xover_absolute <- glodapv2_xover %>% 
  filter(parameter %in% c("salinity", "talk", "tco2")) %>% 
  select(parameter,
         offset = sigma_offset,
         offset_sd = sigma_ratio,
         cruise_A = CruiseA_EXPOCODE,
         cruise_B = CruiseB_EXPOCODE)

glodapv2_xover_ratio <- glodapv2_xover %>% 
  filter(!(parameter %in% c("salinity", "talk", "tco2"))) %>% 
  select(parameter,
         offset = sigma_offset_sd,
         offset_sd = sigma_ratio_sd,
         cruise_A = CruiseA_EXPOCODE,
         cruise_B = CruiseB_EXPOCODE)

glodapv2_xover <- bind_rows(
  glodapv2_xover_absolute,
  glodapv2_xover_ratio
)


rm(glodapv2_xover_files, glodapv2_2021_xover_files,
   glodapv2_xover_absolute, glodapv2_xover_ratio)

# tables created between glodapv2 and glodapv2.2021
# provided by Nico Lange

glodapv2_2021_xover_files <- fs::dir_ls(paste0(path_crossover, "/glodapv2_2021"))

glodapv2_2021_xover <- glodapv2_2021_xover_files %>% 
  map_dfr(readxl::read_excel)

glodapv2_2021_xover <- glodapv2_2021_xover %>%
  rename(parameter = Parameter) %>%
  mutate(parameter = recode(parameter,
                            "alkalinity" = "talk")) %>%
  filter(
    parameter %in%
      c(
        "tco2",
        "nitrate",
        "oxygen",
        "phosphate",
        "salinity",
        "silicate",
        "talk"
      )
  )


glodapv2_2021_xover <- glodapv2_2021_xover %>% 
  rename(offset = Offset,
         offset_sd = Std,
         cruise_A = Cruise_A,
         cruise_B = Cruise_B)


# tables for data not qc'ed in the regular GLODAP release
# provided by Nico Lange

glodapv2_2021_xover_files_add <-
  fs::dir_ls(paste0(path_crossover, "/glodapv2_2021_additional_crossover"))

glodapv2_2021_xover_add <- glodapv2_2021_xover_files_add %>% 
  map_dfr(readxl::read_excel)

glodapv2_2021_xover_add <- glodapv2_2021_xover_add %>%
  rename(parameter = Parameter) %>%
  mutate(parameter = recode(parameter,
                            "alkalinity" = "talk"))


glodapv2_2021_xover_add <- glodapv2_2021_xover_add %>% 
  rename(offset = Offset,
         offset_sd = Std,
         cruise_A = Cruise_A,
         cruise_B = Cruise_B)

```

## Missing/flagged cruises

```{r read_GLODAPv2_2021_missing_flagged_cruises}

GLODAP_cruises_missing <-
  read_csv(
    paste(
      path_glodapv2_2021,
      "GLODAPv2.2021_major_cruises_missing_flagged.csv",
      sep = ""
    )
  )

```

## IO CRM data

```{r read_IO_CRM}

IO_CRM_meas <-
  read_csv(
    paste(
      path_glodapv2_CRM,
      "/Millero_1998_Tab2.csv",
      sep = ""
    )
  )

CRM_ref <-
  read_csv(
    paste(
      path_glodapv2_CRM,
      "/Dickson_CRM_reference_values_20211215.csv",
      sep = ""
    )
  )

```

# Data preparation

## Correct qc flag

From an email conversation with Nico Lange

*Yes, we are aware of these faulty(!) calculated TA data (using DIC and fCO2). It is linked to v2.2020 where we've added fCO2 to the "missing carbon calculation matrix". Overall, including fCO2 in these calculations has worked great to fill some missing carbon gaps. However, for this cruise in particular the fCO2 values have most likely been converted wrongly to 20°C and are thus off! The problem of this all is that we haven't really done a 2nd QC on the fCO2 values neither have we defined the corresponding "G2fCO2qc" variable, hence for the sake of consistency we kept all fCO2 values in. Again and unfortunately, in this particular case it led to the bad calculations of TA data.... We plan to do a full 2nd QC on all (!) fCO2 data for v3.*

*But you have indeed found a flaw in our merging script, as the corresponding calculated TA values should not have received a 2nd QC flag of 1! I missed out on adding a line to our merging script to accommodate for the non-existence of 2nd fCO2 flags in the carbon calculation matrix.*

*So long story short: Thank you very much for finding this flaw and letting me know of it!*

and

*Yes, the all calculated TA data from cruise 695 should have a talkqc of 0 (as they are based upon un QC'd fCO2 data...).*

*And no (thanks to your hint and questions), I figured that **this wrongly assigned 2nd QC flag is a problem for all calculated carbon data, which used fCO2 for the calculations**. However, luckily this is not really often the case.*

*You can check if thats the case by looking at which other carbon parameters are measured, i.e. by **checking their primary flags (e.g. G2talkf, G2tco2f and G2phts25p0f and G2fco2f). If only two are measured and one of them is fCO2, it means that the other carbon parameters (the ones with a primary flag of 0) are calculated using fCO2. Hence, for these instances no 2nd QC is done and the corresponding qc flag should be 0 and not 1.***

```{r check_qc_values, eval=FALSE}

GLODAP_qc_check <- GLODAP %>% 
  filter(cruise == 717) %>% 
  count(talkqc)

```


```{r correct_qc_flag}

# calculate number of measured co2 system variables

GLODAP <- GLODAP %>%
  mutate(measured_CO2_vars = rowSums(select(., c(
    tco2f, talkf, fco2f, phts25p0f
  )) == 2))

# identify cruises on which talk/tco2 was calculated

talk_qc_error_cruises <- GLODAP %>%
  select(cruise, tco2:phtsqc, measured_CO2_vars) %>% 
  filter(measured_CO2_vars == 2,
         fco2f == 2,
         talkf == 0) %>% 
  distinct(cruise, talkf, talkqc, fco2f)

tco2_qc_error_cruises <- GLODAP %>%
  select(cruise, tco2:phtsqc, measured_CO2_vars) %>% 
  filter(measured_CO2_vars == 2,
         fco2f == 2,
         tco2f == 0) %>% 
  distinct(cruise, tco2f, tco2qc, fco2f)

talk_qc_error_cruises %>% 
  write_csv("data/talk_qc_error_cruises_GLODAPv2_2021.csv")

tco2_qc_error_cruises %>% 
  write_csv("data/tco2_qc_error_cruises_GLODAPv2_2021.csv")

rm(talk_qc_error_cruises, tco2_qc_error_cruises)


# set qc = 0 for tco2 and talk values calculated from fco2   

GLODAP <- GLODAP %>%
  mutate(tco2qc = if_else(measured_CO2_vars == 2 &
                            fco2f == 2 & tco2f == 0,
                          0,
                          tco2qc))

GLODAP <- GLODAP %>%
  mutate(talkqc = if_else(measured_CO2_vars == 2 &
                            fco2f == 2 & talkf == 0,
                          0,
                          talkqc))

GLODAP <- GLODAP %>% 
  select(-measured_CO2_vars)

```

```{r identify_talk_tco2_calculated_from_pH_fco2, eval=FALSE}

# calculate number of measured co2 system variables

GLODAP <- GLODAP %>%
  mutate(measured_CO2_vars = rowSums(select(., c(
    tco2f, talkf, fco2f, phts25p0f
  )) == 2))

# identify cruises on which talk/tco2 was calculated

tco2_talk_calc <- GLODAP %>%
  select(cruise, tco2:phtsqc, measured_CO2_vars) %>% 
  filter(measured_CO2_vars == 2,
         fco2f == 2,
         phts25p0f == 2)

GLODAP <- GLODAP %>% 
  select(-measured_CO2_vars)

```


## Harmonize nomenclature

```{r harmonize_variables}

# create date column
GLODAP <- GLODAP %>%
  mutate(date = ymd(paste(year, month, day))) %>%
  relocate(date)

# harmonize column names
GLODAP <- GLODAP  %>%
  rename(sal = salinity,
         temp = temperature)

# harmonize coordinates
GLODAP <- GLODAP  %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))


```

## Horizontal gridding

For merging with other data sets, all observations were grouped into latitude intervals of:

-   1° x 1°

```{r grid_spatially_1x1}

GLODAP <- m_grid_horizontal(GLODAP)

```

## Apply basin mask

```{r apply_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)

GLODAP <- inner_join(GLODAP, basinmask)

```

## Add row number

```{r add_row_number}

GLODAP <- GLODAP  %>%  
  mutate(row_number = row_number()) %>% 
  relocate(row_number)

```

## Split CO2 and tracers

```{r split_co2_tracer}

# remove irrelevant columns
GLODAP <- GLODAP %>%
  select(-c(region,
            month:minute,
            maxsampdepth, sigma0:sigma4,
            nitrite:nitritef))


GLODAP_tracer <- GLODAP %>% 
  select(row_number:gamma,
         cfc11:sf6f,
         basin_AIP)

# select relevant columns
GLODAP <- GLODAP %>%
  select(row_number:talkqc,
         basin_AIP)


```


## Subset measured data

### tco2

The vast majority of rows is removed due to missing `tco2` observations.

```{r tco2_na_subset}

GLODAP <- GLODAP %>% 
  filter(!is.na(tco2))

```

### tracer

Rows are removed if no tracer observation is available.

```{r tracer_na_subset}

GLODAP_tracer <- GLODAP_tracer %>%
  filter(if_any(
    c(
      cfc11,
      cfc12,
      cfc113,
      ccl4,
      sf6,
      pcfc11,
      pcfc12,
      pcfc113,
      pccl4,
      psf6
    ),
    ~ !is.na(.)
  ))

```

## Create clean observations grid

### tco2

```{r create_clean_obs_grid}

GLODAP_obs_grid <- GLODAP %>% 
  count(lat, lon)

```


```{r grid_by_year, fig.asp=3}

GLODAP_grid_year <- GLODAP %>%
  count(lat, lon, year)

map +
  geom_raster(data = GLODAP_grid_year,
              aes(lon, lat)) +
  facet_wrap(~ year, ncol=3)

```

### tracer

```{r create_clean_obs_grid_tracer}

GLODAP_obs_grid_tracer <- GLODAP_tracer %>% 
  count(lat, lon)

```


```{r grid_by_year_tracer, fig.asp=3}

GLODAP_grid_year_tracer <- GLODAP_tracer %>%
  count(lat, lon, year)

map +
  geom_raster(data = GLODAP_grid_year_tracer,
              aes(lon, lat)) +
  facet_wrap(~ year, ncol=3)

```


# Flagging

## qc

```{r qc_flagging, fig.asp=1.5}

qc_flag <- full_join(
  GLODAP,
  GLODAP_expocodes
)

qc_flag <- qc_flag %>%
  mutate(decade = cut(
    year,
    seq(1990, 2020, 10),
    right = FALSE,
    labels = c("1990-1999", "2000-2009", "2010-2019")
  ),
  .after = year) %>%
  filter(!is.na(decade)) %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("qc")) %>%
  pivot_longer(ends_with("qc"),
               names_to = "parameter",
               values_to = "value")

qc_flag_grid <- qc_flag %>%
  count(lon, lat, decade, parameter, value)

p_qc_flag_map <- qc_flag_grid %>% 
  group_split(value) %>%
  # head(1) %>% 
  map(
    ~map +
  geom_tile(data = .x,
            aes(lon, lat, fill=n)) +
  facet_grid(parameter ~ decade) +
  labs(title = paste("qc flag =", unique(.x$value))) +
    scale_fill_viridis_c(option = "magma",
                         direction = -1,
                         trans = "log10")
  )

p_qc_flag_map

pdf("output/qc_flag_coverage_maps.pdf")
p_qc_flag_map
dev.off()

qc_flag %>% 
  filter(basin_AIP == "Pacific",
         decade == "1990-1999") %>% 
  count(cruise_expocode, parameter, value) %>% 
  arrange(value, -n) %>% 
  write_csv("output/Pacific_1990_qc_by_cruise_and_parameter.csv")

rm(qc_flag, qc_flag_grid, p_qc_flag_map)

```

## f

```{r f_flagging, fig.asp=1.5}

f_flag <- full_join(
  GLODAP,
  GLODAP_expocodes
)

f_flag <- f_flag %>%
  mutate(decade = cut(
    year,
    seq(1990, 2020, 10),
    right = FALSE,
    labels = c("1990-1999", "2000-2009", "2010-2019")
  ),
  .after = year) %>%
  filter(!is.na(decade)) %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("f")) %>%
  pivot_longer(ends_with("f"),
               names_to = "parameter",
               values_to = "value")

f_flag_grid <- f_flag %>%
  count(lon, lat, decade, parameter, value)

p_f_flag_map <- f_flag_grid %>% 
  group_split(value) %>%
  # head(1) %>% 
  map(
    ~map +
  geom_tile(data = .x,
            aes(lon, lat, fill=n)) +
  facet_grid(parameter ~ decade) +
  labs(title = paste("f flag =", unique(.x$value))) +
    scale_fill_viridis_c(option = "magma",
                         direction = -1,
                         trans = "log10")
  )

p_f_flag_map

pdf("output/f_flag_coverage_maps.pdf")
p_f_flag_map
dev.off()

f_flag %>% 
  filter(basin_AIP == "Pacific",
         decade == "1990-1999") %>% 
  count(cruise_expocode, parameter, value) %>% 
  arrange(value, -n) %>% 
  write_csv("output/Pacific_1990_f_by_cruise_and_parameter.csv")

rm(f_flag, f_flag_grid, p_f_flag_map)

```



# Data loss

```{r data_loss_prepartion}

loss_all <- full_join(
  GLODAP,
  GLODAP_expocodes
)

loss_all <- loss_all %>%
  mutate(decade = cut(
    year,
    seq(1989, 2019, 10),
    right = FALSE,
    labels = c("1989-1999", "2000-2009", "2010-2019")
  ),
  .after = year) %>%
  filter(!is.na(decade))

map +
  geom_tile(data = loss_all %>% distinct(lon, lat, decade),
            aes(lon, lat)) +
  facet_grid(decade ~ .)


loss <- loss_all %>% 
  filter(if_all(ends_with("f"), ~ . != 9))

loss_all_n <- loss_all %>% 
  count(basin_AIP, decade)

loss_n <- loss %>% 
  count(basin_AIP, decade)

```

## qc

```{r qc_loss}

loss_qc <- loss %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("qc")) %>%
  pivot_longer(ends_with("qc"),
               names_to = "parameter",
               values_to = "value") %>% 
  mutate(parameter = str_remove(parameter, "qc"))

loss_qc <- loss_qc %>%
  count(cruise_expocode, basin_AIP, decade, parameter, value) %>%
  pivot_wider(
    names_from = value,
    names_prefix = "qc_",
    values_from = n,
    values_fill = 0
  ) %>%
  mutate(n_cruise = qc_0 + qc_1,
         category = if_else(qc_0 <= 0.1 * (n_cruise), "OK", "loss"))

loss_qc_cruise <- loss_qc %>%
  mutate(parameter_class = if_else(
    parameter %in% c("tco2", "talk", "phosphate"),
    "target",
    "predictor"
  )) %>%
  count(cruise_expocode,
        basin_AIP,
        decade,
        n_cruise,
        parameter_class,
        category) %>% 
  pivot_wider(names_from = category,
              values_from = n,
              values_fill = 0) %>% 
  select(-OK) %>% 
  pivot_wider(names_from = parameter_class,
              values_from = loss) %>% 
  group_by(basin_AIP, decade) %>%
  mutate(rank_n_cruise = rank(-n_cruise)) %>%
  ungroup()

loss_qc_cruise <- full_join(loss_qc_cruise, loss_n)

loss_qc_cruise <- loss_qc_cruise %>% 
  mutate(n_cruise_rel = 100 * n_cruise / n) %>% 
  arrange(basin_AIP, decade, -n_cruise_rel) %>% 
  group_by(basin_AIP, decade) %>% 
  mutate(n_cruise_rel_cum = cumsum(n_cruise_rel)) %>% 
  ungroup() %>% 
  select(-n)

loss_qc_cruise <- loss_qc_cruise %>% 
  pivot_longer(predictor:target,
               names_to = "parameter_class",
               values_to = "loss") %>% 
  mutate(loss = as.factor(loss))

grey_plasma <- c("grey80", viridisLite::plasma(4))

loss_qc_cruise <- loss_qc_cruise %>%
  filter(n_cruise_rel >= 3)

loss_qc_cruise %>%
  group_split(basin_AIP) %>%
  # head(3) %>%
  map(
    ~ ggplot(data = .x,
             aes(rank_n_cruise, n_cruise_rel, fill = loss)) +
      geom_point(shape = 21, size = 2) +
      scale_fill_manual(values = grey_plasma,
                        name = "variables missing") +
      facet_grid(decade ~ parameter_class) +
      labs(title = paste("basin_AIP:", unique(.x$basin_AIP))) +
      ylim(0, NA)
  )



loss_qc_cruise %>% 
  filter(loss != 0) %>% 
  select(basin_AIP, decade, parameter_class, rank_n_cruise, cruise_expocode) %>% 
  arrange(basin_AIP, decade, parameter_class, rank_n_cruise) %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "300px")
  

```

```{r qc_loss_maps}

loss_grid <- loss %>% distinct(lon, lat, cruise_expocode)

loss_qc_grid <- left_join(loss_qc_cruise,
                          loss_grid)

map +
  geom_tile(data = loss_qc_grid,
            aes(lon, lat, fill = loss)) +
  facet_grid(decade ~ parameter_class) +
  scale_fill_manual(values = grey_plasma)

loss_qc_grid %>% filter(loss != 0) %>%
  group_split(parameter_class, decade) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = cruise_expocode)) +
      scale_fill_brewer(palette = "Paired") +
      facet_grid(decade ~ parameter_class)
  )

```




## f

```{r f_loss}

loss_f <- loss %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("f")) %>%
  pivot_longer(ends_with("f"),
               names_to = "parameter",
               values_to = "value") %>% 
  mutate(parameter = str_remove(parameter, "f"))

loss_f <- loss_f %>%
  count(cruise_expocode, basin_AIP, decade, parameter, value) %>%
  pivot_wider(
    names_from = value,
    names_prefix = "f_",
    values_from = n,
    values_fill = 0
  ) %>%
  mutate(n_cruise = f_0 + f_2,
         category = if_else(f_0 <= 0.1 * (n_cruise), "OK", "loss"))

loss_f_cruise <- loss_f %>%
  mutate(parameter_class = if_else(
    parameter %in% c("tco2", "talk", "phosphate"),
    "target",
    "predictor"
  )) %>%
  count(cruise_expocode,
        basin_AIP,
        decade,
        n_cruise,
        parameter_class,
        category) %>% 
  pivot_wider(names_from = category,
              values_from = n,
              values_fill = 0) %>% 
  select(-OK) %>% 
  pivot_wider(names_from = parameter_class,
              values_from = loss) %>% 
  group_by(basin_AIP, decade) %>%
  mutate(rank_n_cruise = rank(-n_cruise)) %>%
  ungroup()

loss_f_cruise <- full_join(loss_f_cruise, loss_n)

loss_f_cruise <- loss_f_cruise %>% 
  mutate(n_cruise_rel = 100 * n_cruise / n) %>% 
  arrange(basin_AIP, decade, -n_cruise_rel) %>% 
  group_by(basin_AIP, decade) %>% 
  mutate(n_cruise_rel_cum = cumsum(n_cruise_rel)) %>% 
  ungroup() %>% 
  select(-n)

loss_f_cruise <- loss_f_cruise %>% 
  pivot_longer(predictor:target,
               names_to = "parameter_class",
               values_to = "loss") %>% 
  mutate(loss = as.factor(loss))

grey_plasma <- c("grey80", viridisLite::plasma(4))

loss_f_cruise <- loss_f_cruise %>%
    filter(n_cruise_rel >= 3)

loss_f_cruise %>%
  # filter(n_cruise_rel_cum <= 90) %>%
  group_split(basin_AIP) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(rank_n_cruise, n_cruise, fill = loss)) +
      geom_point(shape = 21, size = 2) +
      scale_fill_manual(values = grey_plasma,
                        name = "variables missing") +
      facet_grid(decade ~ parameter_class) +
      labs(title = paste("basin_AIP:", unique(.x$basin_AIP))) +
      ylim(0, NA)
  )


loss_f_cruise %>% 
  filter(loss != 0) %>% 
  select(basin_AIP, decade, parameter_class, rank_n_cruise, cruise_expocode) %>% 
  arrange(basin_AIP, decade, parameter_class, rank_n_cruise) %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "300px")
  

```

```{r f_loss_maps}

loss_grid <- loss %>% distinct(lon, lat, cruise_expocode)

loss_f_grid <- left_join(loss_f_cruise,
                          loss_grid)
map +
  geom_tile(data = loss_f_grid,
            aes(lon, lat, fill = loss)) +
  facet_grid(decade ~ parameter_class) +
  scale_fill_manual(values = grey_plasma)

loss_f_grid %>% filter(loss != 0) %>%
  group_split(parameter_class, decade) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = cruise_expocode)) +
      scale_fill_brewer(palette = "Paired") +
      facet_grid(decade ~ parameter_class)
  )

```


## f == 9

```{r f9_loss}

loss_f9 <- loss_all %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("f")) %>%
  pivot_longer(ends_with("f"),
               names_to = "parameter",
               values_to = "value") %>% 
  mutate(parameter = str_remove(parameter, "f"))

loss_f9 <- loss_f9 %>%
  count(cruise_expocode, basin_AIP, decade, parameter, value) %>%
  pivot_wider(
    names_from = value,
    names_prefix = "f_",
    values_from = n,
    values_fill = 0
  ) %>%
  mutate(n_cruise = f_0 + f_2 + f_9,
         category = if_else(f_9 <= 0.1 * (n_cruise), "OK", "loss"))

loss_f9_cruise <- loss_f9 %>%
  mutate(parameter_class = if_else(
    parameter %in% c("tco2", "talk", "phosphate"),
    "target",
    "predictor"
  )) %>%
  count(cruise_expocode,
        basin_AIP,
        decade,
        n_cruise,
        parameter_class,
        category) %>% 
  pivot_wider(names_from = category,
              values_from = n,
              values_fill = 0) %>% 
  select(-OK) %>% 
  pivot_wider(names_from = parameter_class,
              values_from = loss) %>% 
  group_by(basin_AIP, decade) %>%
  mutate(rank_n_cruise = rank(-n_cruise)) %>%
  ungroup()

loss_f9_cruise <- full_join(loss_f9_cruise, loss_all_n)

loss_f9_cruise <- loss_f9_cruise %>% 
  mutate(n_cruise_rel = 100 * n_cruise / n) %>% 
  arrange(basin_AIP, decade, -n_cruise_rel) %>% 
  group_by(basin_AIP, decade) %>% 
  mutate(n_cruise_rel_cum = cumsum(n_cruise_rel)) %>% 
  ungroup() %>% 
  select(-n)

loss_f9_cruise <- loss_f9_cruise %>% 
  pivot_longer(predictor:target,
               names_to = "parameter_class",
               values_to = "loss") %>% 
  mutate(loss = as.factor(loss))

grey_plasma <- c("grey80", viridisLite::plasma(4))

loss_f9_cruise <- loss_f9_cruise %>%
    filter(n_cruise_rel >= 3)

loss_f9_cruise %>%
  group_split(basin_AIP) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(rank_n_cruise, n_cruise, fill = loss)) +
      geom_point(shape = 21, size = 2) +
      scale_fill_manual(values = grey_plasma,
                        name = "variables missing") +
      facet_grid(decade ~ parameter_class) +
      labs(title = paste("basin_AIP:", unique(.x$basin_AIP))) +
      ylim(0, NA)
  )


loss_f9_cruise %>% 
  filter(loss != 0) %>% 
  select(basin_AIP, decade, parameter_class, rank_n_cruise, cruise_expocode) %>% 
  arrange(basin_AIP, decade, parameter_class, rank_n_cruise) %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "300px")
  

```

```{r f9_loss_maps}

loss_all_grid <- loss_all %>% distinct(lon, lat, cruise_expocode)

loss_f9_grid <- left_join(loss_f9_cruise,
                          loss_all_grid)
map +
  geom_tile(data = loss_f9_grid,
            aes(lon, lat, fill = loss)) +
  facet_grid(decade ~ parameter_class) +
  scale_fill_manual(values = grey_plasma)

loss_f9_grid %>% filter(loss != 0) %>%
  group_split(parameter_class, decade) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = cruise_expocode)) +
      scale_fill_brewer(palette = "Paired") +
      facet_grid(decade ~ parameter_class)
  )

```

## Overview

```{r overview}

expocodes_missing <- GLODAP_cruises_missing %>%
  distinct(cruise_expocode) %>%
  pull()

missing_cruise_grid <- loss_all %>%
  filter(cruise_expocode %in% expocodes_missing) %>% 
  distinct(cruise_expocode, decade, lon, lat)

missing_cruise_grid %>%
  group_split(decade) %>%
  # head(1) %>%
  map(
    ~ map +
      geom_tile(data = .x,
                aes(lon, lat, fill = str_sub(
                  cruise_expocode, 1, 4
                ))) +
      facet_grid(decade ~ .) +
      scale_fill_brewer(palette = "Paired",
                        name = "RV")
  )

```


## P18 phosphate

```{r P18_nitrate}

P18 <- full_join(
  GLODAP,
  GLODAP_expocodes
)

P18 <- P18 %>% 
  filter(cruise_expocode %in% c("33RO20161119",
                                "33RO20071215",
                                "31DS19940126"))

P18 %>% 
  ggplot(aes(date, lat)) +
  geom_point() +
  facet_grid() +
  facet_wrap(cruise_expocode ~., scales = "free_x", ncol = 1)


P18 %>% 
  filter(!is.na(nitrate)) %>% 
  ggplot(aes(lat, depth, col= nitrate)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(cruise_expocode ~.)

P18_grid <- P18 %>% 
  select(lat, lon, depth, cruise_expocode, nitrate) %>% 
  mutate(depth = as.numeric(as.character(cut(depth,
                     seq(0,1e4, 500), 
                     seq(250,1e4,500))))) %>% 
  group_by(lat, depth, cruise_expocode) %>% 
  summarise(nitrate = mean(nitrate, na.rm=TRUE)) %>% 
  ungroup()

P18_grid %>% 
  ggplot(aes(lat, depth, col= nitrate)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(cruise_expocode ~.)

P18_grid_offset <- P18_grid %>% 
  pivot_wider(names_from = cruise_expocode,
              values_from = nitrate) %>% 
  mutate(delta_nitrate_1994_2007 = (`31DS19940126` - `33RO20071215`) / `33RO20071215`,
         delta_nitrate_1994_2016 = (`31DS19940126` - `33RO20161119`) / `33RO20071215`,
         delta_nitrate_2007_2016 = (`33RO20071215` - `33RO20161119`) / `33RO20071215`) %>% 
  select(lat, depth, starts_with("delta")) %>% 
  pivot_longer(starts_with("delta"),
               values_to = "delta_nitrate",
               names_to = "years",
               names_prefix = "delta_nitrate_") %>% 
  filter(delta_nitrate > -20,
         depth > 1500)

P18_grid_offset %>% 
  ggplot(aes(lat, depth, col= delta_nitrate)) +
  geom_point() +
  scale_color_divergent() +
  scale_y_reverse() +
  facet_grid(years ~.)

P18_grid_offset %>%
  group_by(lat, years) %>%
  summarise(delta_nitrate = mean(delta_nitrate, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(lat, delta_nitrate, col = years, fill = years)) +
  geom_hline(yintercept = 0) +
  stat_smooth(method = "lm", formula = y ~ x + I(x ^ 2)) +
  geom_point() +
  geom_line()


rm(P18, P18_grid)

```


## A16

```{r A16}

A16 <- full_join(
  GLODAP,
  GLODAP_expocodes
)

A16 <- A16 %>% 
  filter(cruise_expocode %in% c(
    "33MW19930704" #A16N-1993
    ))

map + 
  geom_tile(data = A16 %>% distinct(lon, lat),
            aes(lon, lat))

A16 %>% 
  select(ends_with(c("qc"))) %>% 
  pivot_longer(everything(),
               names_to = "flag",
               values_to = "value") %>% 
  distinct(flag, value)

rm(A16)

```


# Adjustments

Typically, the reasons for multiple expocode entries of the same cruise in the adjustment table list are:

1) The cruise adjustments are different for different station, i.e. station split (e.g. 316N19821201)

-> How to merge? Based on first and last station? Cruise_ID not in GLODAP merged master file.

2) The cruise adjustments are different for different legs (e.g. 316N19871123.6) but have been merged into one cruise (316N19871123) for the product

-> How to merge? Based on first and last station?

3) The cruise adjustments have been updated/changed through the versions, here always look for the most recent entry (see table below) (e.g. 320620180309)

For the expocodes not listed in the expocode list the reason is that INDIGO has been splitted into three cruises: 35MF1985-1987 and the same holds for SAVE (316N1987 - 6legs). Further 49HH20011208 has been assigned wrongly and corrected to 49HH20011127.

Remove expocode INDIGO and maintain only 35MF19850224.
Remove expocode SAVE and maintain only 316N1987.


```{r prepare_adjustments}

GLODAP_adjustments <- GLODAP_adjustments %>%
  select(cruise_expocode,
         first_station, last_station,
         version,
         calculated_carbon_parameter,
         ends_with("_adj")) %>% 
  rename(talk_adj = alkalinity_adj)

# Remove cruises INDIGO and SAVE

GLODAP_adjustments <- 
  GLODAP_adjustments %>% 
  filter(!(cruise_expocode %in% c("INDIGO", "SAVE")))

# correct expocode 49HH20011208 to 49HH20011127

GLODAP_adjustments <- 
  GLODAP_adjustments %>% 
  mutate(cruise_expocode = if_else(
    cruise_expocode == "49HH20011208",
    "49HH20011127",
    cruise_expocode
  ))


# select latest adjustment versions

GLODAP_adjustments <- 
  GLODAP_adjustments %>% 
  group_by(cruise_expocode, first_station) %>% 
  mutate(n = n(),
         version_max = max(version)) %>%
  ungroup() %>% 
  filter(version == version_max | is.na(version)) %>% 
  select(-c(version_max, version, n))

# harmonize multiple cruise expocodes of 316N1987

GLODAP_adjustments <- GLODAP_adjustments %>% 
  # filter(str_detect(cruise_expocode, "\\.")) %>% 
  mutate(cruise_expocode = str_split(cruise_expocode,
                                     "\\.",
                                     simplify = TRUE)[,1])

# correct one wrong last_cruise label

GLODAP_adjustments <- GLODAP_adjustments %>%
  mutate(
    last_station = if_else(
      cruise_expocode == "318M20091121" &
        first_station == 1,
      127,
      last_station
    )
  )

# merge with expocode table
GLODAP_adjustments <- full_join(GLODAP_adjustments, GLODAP_expocodes) %>% 
  relocate(cruise)



GLODAP_adjustments_NA_cruises <- 
  GLODAP_adjustments %>% 
  filter(is.na(cruise))

GLODAP_adjustments_duplicated_cruises <- 
  GLODAP_adjustments %>% 
  group_by(cruise_expocode, cruise) %>% 
  mutate(n = n()) %>%
  ungroup() %>% 
  filter(n != 1)


GLODAP_adjustments %>% 
  pivot_longer(salinity_adj:c13_adj,
               names_to = "parameter",
               values_to = "adjustment") %>% 
  ggplot(aes(adjustment)) +
  geom_histogram() +
  scale_y_log10() +
  facet_wrap(~ parameter, scales = "free_x")


```


# Crossover analysis


```{r merge_GLODAP_expocodes}

GLODAP <-
  left_join(GLODAP,
            GLODAP_adjustments %>%
              distinct(cruise, cruise_expocode))

```

## Histograms

```{r crossover_histograms, fig.asp=1}

GLODAP_adjustments_long <- GLODAP_adjustments %>%
  select(
    cruise_expocode,
    first_station,
    last_station,
    tco2_adj,
    talk_adj,
    phosphate_adj,
    nitrate_adj,
    oxygen_adj,
    silicate_adj,
    salinity_adj
  ) %>%
  pivot_longer(tco2_adj:salinity_adj,
               names_to = "parameter",
               values_to = "adjustment") %>% 
  mutate(parameter = str_remove(parameter, "_adj"))

p_adjustment_histo <- GLODAP_adjustments_long %>% 
  ggplot(aes(adjustment)) +
  geom_histogram() +
  scale_y_log10() +
  facet_wrap(~ parameter, scales = "free_x", ncol = 1)

p_xover_histo <- 
  ggplot() +
  geom_histogram(data = glodapv2_xover,
                 aes(offset)) +
  labs(title = "v2") +
  scale_y_log10() +
  facet_wrap(~ parameter, scales = "free_x", ncol = 1)

p_xover_histo_2021 <- 
  ggplot() +
  geom_histogram(data = glodapv2_2021_xover,
                 aes(offset)) +
  labs(title = "v2_2021") +
  scale_y_log10() +
  facet_wrap(~ parameter, scales = "free_x", ncol = 1)

p_xover_histo + p_xover_histo_2021 + p_adjustment_histo
rm(p_xover_histo, p_xover_histo_2021, p_adjustment_histo)


```

## Adjustment correction

```{r adjustment_correction}

glodapv2_xover <- left_join(
  glodapv2_xover,
  GLODAP_adjustments_long %>%
    select(
      cruise_A = cruise_expocode,
      parameter,
      first_station_A = first_station,
      last_station_A = last_station,
      adjustment_A = adjustment
    )
)

glodapv2_xover <- left_join(
  glodapv2_xover,
  GLODAP_adjustments_long %>%
    select(
      cruise_B = cruise_expocode,
      parameter,
      first_station_B = first_station,
      last_station_B = last_station,
      adjustment_B = adjustment
    )
)

glodapv2_xover <- glodapv2_xover  %>%
  mutate(offset_adj = 
           if_else(parameter %in% c("salinity", "talk", "tco2"),
                   offset + adjustment_A - adjustment_B,
                   offset * adjustment_A / adjustment_B))

glodapv2_2021_xover <- left_join(
  glodapv2_2021_xover,
  GLODAP_adjustments_long %>%
    select(
      cruise_A = cruise_expocode,
      parameter,
      first_station_A = first_station,
      last_station_A = last_station,
      adjustment_A = adjustment
    )
)

glodapv2_2021_xover <- left_join(
  glodapv2_2021_xover,
  GLODAP_adjustments_long %>%
    select(
      cruise_B = cruise_expocode,
      parameter,
      first_station_B = first_station,
      last_station_B = last_station,
      adjustment_B = adjustment
    )
)

glodapv2_2021_xover <- glodapv2_2021_xover  %>%
  mutate(offset_adj = 
           if_else(parameter %in% c("salinity", "talk", "tco2"),
                   offset + adjustment_A,
                   offset * adjustment_A))


xover <- bind_rows(glodapv2_xover,
                   glodapv2_2021_xover)

```

## Missing/flagged data

```{r crossover_missing_flagged_data}

hline_intercept <-
  tibble(parameter = unique(xover$parameter)) %>%
  mutate(intercept = if_else(parameter %in% c("salinity", "talk", "tco2"),
                             0,
                             1))

for (i_expocodes_missing in expocodes_missing) {
  # i_expocodes_missing <- expocodes_missing[1]
  
  cruise <- GLODAP %>%
    filter(cruise_expocode == i_expocodes_missing) %>% 
    rename(salinity = sal)
  
  parameter_qc <- loss_qc %>%
    filter(cruise_expocode == i_expocodes_missing,
           category == "loss") 
  
  print(parameter_qc)
  
  parameter_qc <- parameter_qc %>%
    pull(parameter)
  
  if (length(parameter_qc) > 0) {
    parameter_qc <- parameter_qc %>% str_c(.,"qc")
  }
    
  parameter_f <- loss_f %>%
    filter(cruise_expocode == i_expocodes_missing,
           category == "loss")
  
  print(parameter_f)
  
  parameter_f <- parameter_f %>%
    pull(parameter)
    
  if (length(parameter_f) > 0) {
    parameter_f <- parameter_f %>% str_c(.,"f")
  }
  
  parameter_f9 <- loss_f9 %>%
    filter(cruise_expocode == i_expocodes_missing,
           category == "loss")
  
  print(parameter_f9)
  
  parameter_f9 <- parameter_f9 %>%
    pull(parameter)
  
  if (length(parameter_f9) > 0) {
    parameter_f9 <- parameter_f9 %>% str_c(.,"f")
  }
  
  parameter_check <-
    unique(c(parameter_qc, parameter_f, parameter_f9))
  
  print(parameter_check)
  
  rm(parameter_qc, parameter_f, parameter_f9)
  
  xover_cruise_A <- xover %>%
    filter(cruise_A %in% i_expocodes_missing)
  
  xover_cruise_B <- xover %>%
    filter(cruise_B %in% i_expocodes_missing)
  
  xover_cruise_B_rev <- xover_cruise_B %>%
    rename(
      cruise_A_back = cruise_A,
      cruise_A = cruise_B,
      adjustment_A_back = adjustment_A,
      adjustment_A = adjustment_B
    ) %>%
    rename(cruise_B = cruise_A_back,
           adjustment_B = adjustment_A_back) %>%
    mutate(
      offset = if_else(
        parameter %in% c("salinity", "talk", "tco2"),
        -offset,
        1 / offset
      ),
      offset_adj = if_else(
        parameter %in% c("salinity", "talk", "tco2"),
        -offset_adj,
        1 / offset_adj
      )
    )
  
  xover_cruise <- bind_rows(xover_cruise_A,
                            xover_cruise_B_rev)
  
  xover_cruise <- xover_cruise %>%
    mutate(dateA = ymd(str_sub(cruise_A, 5, 12)),
           dateB = ymd(str_sub(cruise_B, 5, 12)))
  
  
  # xover_cruise <- xover_cruise %>%
  #   mutate(RV = str_sub(cruise_B, 1, 4))
  
  for (i_parameter_check in parameter_check) {
    # i_parameter_check <- parameter_check[1]
    
    cruise_flag_count <- cruise %>%
      count(lon, lat, !!sym(i_parameter_check)) %>%
      group_by(lon, lat) %>%
      mutate(n_rel = 100 * n / sum(n)) %>%
      ungroup()
    
    print(
      map +
        geom_tile(data = cruise_flag_count,
                  aes(lon, lat, fill = n_rel)) +
        scale_fill_viridis_c(option = "magma",
                             direction = -1) +
        facet_wrap(i_parameter_check, ncol = 2) +
        labs(title = i_expocodes_missing,
             subtitle = i_parameter_check)
    )
    
    i_parameter_check_var <- str_remove(i_parameter_check, "f")
    i_parameter_check_var <- str_remove(i_parameter_check_var, "qc")
    
    print(
      cruise %>% 
        ggplot(aes(!!sym(i_parameter_check_var), depth, fill=station)) +
        geom_point(alpha = 0.2, shape = 21) +
        scale_fill_viridis_c() +
        scale_y_reverse() +
        facet_wrap(i_parameter_check, ncol = 2) +
        labs(title = i_expocodes_missing,
             subtitle = i_parameter_check)
    )
    
  }

  p_crossover_ts <- xover_cruise %>%
    ggplot(aes(dateB, offset_adj)) +
    geom_vline(xintercept = ymd(str_sub(i_expocodes_missing, 5)),
               col = "red") +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_point() +
    facet_grid(parameter ~ ., scales = "free_y") +
    labs(title = i_expocodes_missing,
         subtitle = str_c(parameter_check, collapse = "+")) +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical",
      axis.title.x = element_blank()
    )
  
  
  xover_cruise_decade <- xover_cruise %>%
    mutate(decade = cut(
      year(dateB),
      c(1989, 1999, 2009, 2019),
      labels = c("1989-1999", "2000-2009", "2010-2019")
    )) %>%
    filter(!is.na(decade),
           !is.na(offset_adj)) %>%
    group_by(parameter, decade) %>%
    mutate(n = n()) %>%
    ungroup() %>% 
    filter(n > 2)
  
  
  p_crossover_decadal <-
    ggplot() +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_violin(
      data = xover_cruise_decade,
      aes(x = decade, y = offset_adj),
      fill = "gold"
    ) +
    geom_boxplot(
      data = xover_cruise_decade,
      aes(x = decade, y = offset_adj),
      width = 0.2
    ) +
    labs(title = "Decadal averages") +
    facet_grid(parameter ~ ., scales = "free_y") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 90))
  
  print(
  p_crossover_ts + p_crossover_decadal +
    plot_layout(widths = c(2, 1))
  )
  
  rm(p_crossover_ts, p_crossover_decadal)
  
}


```
## IO 1990 data

```{r crossover_analysis_data, fig.asp=1.2}

IO_1990_expocodes <- GLODAP %>%
  filter(str_detect(cruise_expocode, "316N199") &
           basin_AIP == "Indian") %>%
  distinct(cruise_expocode) %>%
  pull()

xover_IO_1990_A <- xover %>%
  filter(cruise_A %in% IO_1990_expocodes)

xover_IO_1990_B <- xover %>%
  filter(cruise_B %in% IO_1990_expocodes)

xover_IO_1990_B_rev <- xover_IO_1990_B %>%
  rename(
    cruise_A_back = cruise_A,
    cruise_A = cruise_B,
    adjustment_A_back = adjustment_A,
    adjustment_A = adjustment_B
  ) %>%
  rename(cruise_B = cruise_A_back,
         adjustment_B = adjustment_A_back) %>%
  mutate(
    offset = if_else(parameter %in% c("salinity", "talk", "tco2"),
                     -offset,
                     1/offset),
    offset_adj = if_else(
      parameter %in% c("salinity", "talk", "tco2"),
      -offset_adj,
      1/offset_adj
    )
  )

xover_IO_1990 <- bind_rows(xover_IO_1990_A,
                           xover_IO_1990_B_rev)

xover_IO_1990 <- xover_IO_1990 %>%
  mutate(dateA = ymd(str_sub(cruise_A, 5, 12)),
         dateB = ymd(str_sub(cruise_B, 5, 12)))


xover_IO_1990 <- xover_IO_1990 %>%
  mutate(RV = if_else(str_detect(cruise_B, "316N"),
                      "316N",
                      "other"))


xover_IO_1990_decade <- xover_IO_1990 %>%
    mutate(decade = cut(
      year(dateB),
      c(1989, 1999, 2009, 2019),
      labels = c("1989-1999", "2000-2009", "2010-2019")
    )) %>%
    filter(!is.na(decade),
           !is.na(offset_adj),
           !is.na(offset),
           RV != "316N") %>% 
  arrange(dateB)


xover_IO_1990_decade %>%
  group_by(parameter, decade) %>%
  summarise(offset_adj_mean = mean(offset_adj, na.rm = TRUE),
            offset_adj_median = median(offset_adj, na.rm = TRUE)) %>%
  ungroup() %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")



p_crossover_ts <- xover_IO_1990 %>%
  ggplot(aes(dateB, offset, col = RV)) +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Set1") +
  facet_grid(parameter ~ ., scales = "free_y") +
  labs(title = "Crossover 316N199XXXXX") +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    axis.title.x = element_blank()
  )

p_crossover_decadal <-
  ggplot() +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  geom_violin(data = xover_IO_1990_decade,
               aes(x = decade, y = offset), fill="gold") +
  geom_boxplot(data = xover_IO_1990_decade,
               aes(x = decade, y = offset),
               width = 0.2) +
  facet_grid(parameter ~ ., scales = "free_y") +
  labs(title = "Decadal offsets") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90))


p_crossover_ts + p_crossover_decadal +
  plot_layout(widths = c(2, 1))

rm(p_crossover_ts, p_crossover_decadal)

p_crossover_ts <- xover_IO_1990 %>%
  ggplot(aes(dateB, offset_adj, col = RV)) +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Set1") +
  facet_grid(parameter ~ ., scales = "free_y") +
  labs(title = "Crossover 316N199XXXXX") +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    axis.title.x = element_blank()
  )

p_crossover_decadal <-
  ggplot() +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  geom_violin(data = xover_IO_1990_decade,
               aes(x = decade, y = offset_adj), fill="gold") +
  geom_boxplot(data = xover_IO_1990_decade,
               aes(x = decade, y = offset_adj),
               width = 0.2) +
  facet_grid(parameter ~ ., scales = "free_y") +
  labs(title = "Decadal offsets") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90))

  ggplot() +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  # geom_violin(data = xover_IO_1990 %>% 
  #               filter(year(dateB) >= 2000, year(dateB) < 2010),
  #              aes(x = "2000-2009", y = offset_adj), fill="gold") +
  geom_boxplot(data = xover_IO_1990 %>% 
                filter(year(dateB) >= 2000, year(dateB) < 2010),
               aes(x = "2000-2009", y = offset_adj),
               width = 0.2) +
  facet_grid(parameter ~ ., scales = "free_y") +
  labs(title = "Decadal offsets") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90))

p_crossover_ts + p_crossover_decadal +
  plot_layout(widths = c(2, 1))



rm(p_crossover_ts, p_crossover_decadal)

```

# RV activity

```{r RV_activity}

GLODAP_counts <- full_join(
  GLODAP,
  GLODAP_expocodes
)

GLODAP_counts <- GLODAP_counts %>%
  mutate(decade = cut(
    year,
    seq(1990, 2020, 10),
    right = FALSE,
    labels = c("1990-1999", "2000-2009", "2010-2019")
  ), .after = year) %>% 
  filter(!is.na(decade))

GLODAP_counts <- GLODAP_counts %>% 
  mutate(RV = str_sub(cruise_expocode, 1, 4))

RV_activity <- GLODAP_counts %>% 
  count(decade, basin_AIP, RV) %>% 
  group_by(decade, basin_AIP) %>% 
  mutate(n_total = sum(n)) %>% 
  ungroup() %>% 
  mutate(n_prop = 100* n / n_total)

RV_activity <-RV_activity %>% 
  group_by(decade, basin_AIP) %>% 
  mutate(rank = rank(-n_prop)) %>% 
  ungroup()

RV_activity %>% 
  ggplot(aes(rank, n_prop)) +
  geom_line() +
  geom_point() +
  geom_text(data = RV_activity %>% filter(n_prop > 20),
             aes(rank, n_prop, label = RV),
             nudge_x = 5) +
  labs(y = "proportion of tco2 samples (%)") +
  facet_grid(decade ~ basin_AIP)

rm(RV_activity)

```



# Largest cruises

```{r large_cruises, fig.asp=0.5}

large_cruises <- GLODAP_counts %>% 
  count(decade, basin_AIP, cruise_expocode) %>% 
  group_by(decade, basin_AIP) %>% 
  mutate(n_total = sum(n)) %>% 
  ungroup() %>% 
  mutate(n_prop = 100* n / n_total)

large_cruises <- large_cruises %>% 
  group_by(decade, basin_AIP) %>% 
  mutate(rank = rank(-n_prop)) %>% 
  ungroup()


large_cruises %>%
  group_split(decade, basin_AIP) %>%
  head(1) %>%
  map(
    ~
      ggplot(data = .x,
             aes(rank, n_prop)) +
      geom_line() +
      geom_point(
        data = .x %>% filter(rank <= 5),
        aes(rank, n_prop, fill = cruise_expocode), shape = 21) +
      scale_fill_brewer(palette = "Set1") +
      xlim(0, max(large_cruises$rank)) +
      labs(y = "proportion of tco2 samples (%)") +
      facet_grid(decade ~ basin_AIP)
  )

large_cruises %>%
  filter(rank <= 5) %>% 
  select(decade, basin_AIP, rank, n_prop, cruise_expocode) %>% 
  mutate(n_prop = round(n_prop, 1)) %>% 
  arrange(decade, basin_AIP, rank) %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(height = "300px")

rm(GLODAP_count, large_cruises)

```



# Indian Ocean 1990 CRM

```{r IO_1990_CRM}

IO_CRM_meas <- IO_CRM_meas %>%
  fill(cruise:batch) %>% 
  select(-starts_with("ph")) %>% 
  rename(talk_meas = talk_ave,
         tco2_meas = tco2_ave)
  
CRM_ref <- CRM_ref %>% 
  select(-c(date, comment, sal)) %>% 
  rename(talk_ref = talk,
         tco2_ref = tco2)

IO_CRM_offset <-
  left_join(IO_CRM_meas,
            CRM_ref) %>% 
  mutate(batch = as.factor(batch))

IO_CRM_offset <- IO_CRM_offset %>% 
  mutate(talk_offset = talk_meas - talk_ref,
         tco2_offset = tco2_meas - tco2_ref)

IO_CRM_offset <- IO_CRM_offset %>% 
  select(-c(talk_meas:talk_ref)) %>% 
  pivot_longer(ends_with("_offset"),
               values_to = "offset",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "_offset"),
         start_date = mdy(start_date))

IO_CRM_offset %>% 
  ggplot(aes(offset)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~ parameter)

IO_CRM_offset <- IO_CRM_offset %>% 
  filter(cell != "All")

IO_CRM_offset_mean <- IO_CRM_offset %>% 
  group_by(parameter) %>% 
  summarise(offset_mean = mean(offset),
            offset_sd = sd(offset)) %>% 
  ungroup()

IO_CRM_offset %>%
  filter(parameter == "talk") %>%
  ggplot() +
  scale_fill_brewer(palette = "Set1",
                    name = "CRM batch") +
  geom_hline(data = IO_CRM_offset_mean %>% filter(parameter == "talk"),
             aes(yintercept = offset_mean)) +
  geom_hline(
    data = IO_CRM_offset_mean %>% filter(parameter == "talk"),
    aes(yintercept = offset_mean - offset_sd),
    linetype = 2
  ) +
  geom_hline(
    data = IO_CRM_offset_mean %>% filter(parameter == "talk"),
    aes(yintercept = offset_mean + offset_sd),
    linetype = 2
  ) +
  geom_point(aes(start_date, offset, fill = batch, size=n),
             shape = 21) +
  scale_size(name = "Nr of\nmeasurements") +
  labs(x = "Cruise start date",
       y = "TA offset meas-CRM (µmol/kg)",
       title = "RV Knorr IO 1990 - TA reference measurements",
       subtitle = "Data source: Tables 1 and 2 from Millero et al. (1998)")


```


# Write files

```{r write_clean_data_files}

GLODAP  %>%
  select(-cruise_expocode) %>% 
  write_csv(paste(path_preprocessing,
                  "GLODAPv2.2021_preprocessed.csv",
                  sep = ""))

GLODAP_tracer  %>%
  write_csv(paste(
    path_preprocessing,
    "GLODAPv2.2021_preprocessed_tracer.csv",
    sep = ""
  ))

GLODAP_adjustments  %>%
  write_csv(paste(path_preprocessing,
                  "GLODAPv2.2021_adustments.csv",
                  sep = ""))

# GLODAP_adjustments_NA_cruises  %>%
#   select(cruise_expocode, cruise) %>%
#   write_csv(paste(
#     path_preprocessing,
#     "GLODAPv2.2021_adustments_NA_cruises.csv",
#     sep = ""
#   ))
# 
# GLODAP_adjustments_duplicated_cruises  %>%
#   drop_na() %>%
#   write_csv(
#     paste(
#       path_preprocessing,
#       "GLODAPv2.2021_adustments_duplicated_cruises.csv",
#       sep = ""
#     )
#   )

```

# Overview plots

## Assign coarse spatial grid

For the following plots, the cleaned data set was re-opened and observations were gridded spatially to intervals of:

-   5° x 5°

```{r grid_spatially_5x5}

GLODAP <- m_grid_horizontal_coarse(GLODAP)

```

## Histogram Zonal coverage

```{r coverage_histogram_zonal}

GLODAP_histogram_lat <- GLODAP %>%
  group_by(lat_grid) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_lat %>%
  ggplot(aes(lat_grid, n)) +
  geom_col() +
  coord_flip() +
  theme(legend.title = element_blank())

rm(GLODAP_histogram_lat)

```

## Histogram temporal coverage

```{r coverage_histogram_temporal}

GLODAP_histogram_year <- GLODAP %>%
  group_by(year) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_year %>%
  ggplot() +
  geom_col(aes(year, n)) +
  theme(
    axis.title.x = element_blank()
  )

rm(GLODAP_histogram_year)

```

## Zonal temporal coverage (Hovmoeller)

```{r coverage_hovmoeller}

GLODAP_hovmoeller_year <- GLODAP %>%
  group_by(year, lat_grid) %>%
  tally() %>%
  ungroup()

GLODAP_hovmoeller_year %>%
  ggplot(aes(year, lat_grid, fill = log10(n))) +
  geom_tile() +
  geom_vline(xintercept = c(1999.5, 2012.5)) +
  scale_fill_viridis_c(option = "magma", direction = -1) +
  theme(legend.position = "top",
        axis.title.x = element_blank())

rm(GLODAP_hovmoeller_year)

```

## Coverage map

```{r coverage_map, fig.asp=0.5}

map +
  geom_raster(data = GLODAP_obs_grid,
              aes(lon, lat, fill = log10(n))) +
  scale_fill_viridis_c(option = "magma",
                       direction = -1)

```

```{r coverage_map_variable_year, message=FALSE}

GLODAP_obs_grid_all_vars <- GLODAP %>% 
  select(year, lat, lon, cruise, sal, temp, oxygen,
         phosphate, nitrate, silicate, tco2, talk) %>% 
  pivot_longer(cols = sal:talk,
               names_to = "parameter",
               values_to = "value") %>% 
  mutate(presence = if_else(is.na(value), "missing", "available")) %>% 
  count(year, lat, lon, parameter, presence)

GLODAP_obs_grid_all_vars_wide <- GLODAP_obs_grid_all_vars %>% 
  pivot_wider(names_from = "presence",
              values_from = n,
              values_fill = 0) %>% 
  mutate(ratio_available = available/(available+missing))

all_plots <- GLODAP_obs_grid_all_vars_wide %>%
  # mutate(cruise = as.factor(cruise)) %>%
  group_split(year) %>%
  # tail(3) %>%
  map(
    ~ map +
      geom_tile(
        data = .x,
        aes(
          x = lon,
          y = lat,
          width = 1,
          height = 1,
          fill = ratio_available
        )
      ) +
      scale_fill_scico(palette = "berlin",
                       limits = c(0,1)) +
      labs(title = unique(.x$year)) +
      facet_wrap(~ parameter)
  )


pdf(file = paste0(path_preprocessing, "GLODAPv2.2021_preprocessed_coverage_maps.pdf"),
    width = 10, 
    height = 5)
all_plots
dev.off()

```

## Time series

```{r timeseries, fig.asp=1.5, eval=FALSE}

GLODAP_time_series <- GLODAP %>% 
  select(year, basin_AIP, lat, depth, sal, temp,
         oxygen, aou, nitrate, silicate, phosphate,
         tco2, talk)

GLODAP_time_series <- GLODAP_time_series %>% 
  mutate(depth_grid = cut(depth, seq(0,1e4,1000)))

GLODAP_time_series <- GLODAP_time_series %>% 
  pivot_longer(sal:talk,
               names_to = "parameter",
               values_to = "value") %>% 
  filter(!is.na(value),
         !is.na(depth_grid))

GLODAP_time_series %>%
  group_split(basin_AIP, depth_grid) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, value, col = lat)) +
      geom_jitter(alpha = 0.1) +
      scale_color_divergent() +
      facet_grid(parameter ~ depth_grid,
                 scales = "free_y") +
      labs(title = paste(
        "basin_AIP:",
        unique(.x$basin_AIP),
        "| depth_grid:",
        unique(.x$depth_grid)
      ))
  )



```


# CANYON-B

## Prediction

```{r calc_CANYON-B}

source("/net/kryo/work/uptools/co2_calculation/CANYON-B/CANYONB.R")

GLODAP_CB <- GLODAP %>%
  mutate(lon = if_else(lon > 180, lon - 360, lon)) %>%
  arrange(year) %>% 
  select(row_number, year, date, lat, lon, depth, basin_AIP,
         temp, sal, oxygen,
         talk, tco2, nitrate, phosphate, silicate)

# filter rows with essential variables for Canyon-B
GLODAP_CB <- GLODAP_CB %>%
  filter(across(c(lat, lon, depth,
                  temp, sal, oxygen), ~ !is.na(.x)))

GLODAP_CB <- GLODAP_CB %>%
  mutate(as_tibble(
    CANYONB(
      date = paste0(as.character(date), " 12:00"),
      lat = lat,
      lon = lon,
      pres = depth,
      temp = temp,
      psal = sal,
      doxy = oxygen,
      param = c("AT", "CT", "NO3", "PO4", "SiOH4")
    )
  ))

GLODAP_CB <- GLODAP_CB %>%
  select(-ends_with(c("_cim", "_cin", "_cii")))


GLODAP_CB <- GLODAP_CB %>%
  rename(
    "talk_CANYONB" = "AT",
    "tco2_CANYONB" = "CT",
    "nitrate_CANYONB" = "NO3",
    "phosphate_CANYONB" = "PO4",
    "silicate_CANYONB" = "SiOH4"
  )



```

## Comparison to observations

```{r CANYON-B_vs_observationd, fig.asp=0.4}


variables <- c("talk", "tco2", "nitrate", "phosphate", "silicate")

for (i_variable in variables) {
  # i_variable <- variables[1]
  
  # calculate equal axis limits and binwidth
  axis_lims <- GLODAP_CB %>%
    drop_na() %>% 
    summarise(max_value = max(c(max(
      !!sym(i_variable)
    ),
    max(!!sym(
      paste0(i_variable, "_CANYONB")
    )))),
    min_value = min(c(min(
      !!sym(i_variable)
    ),
    min(!!sym(
      paste0(i_variable, "_CANYONB")
    )))))
  
  binwidth_value <- (axis_lims$max_value - axis_lims$min_value) / 60
  axis_lims <- c(axis_lims$min_value, axis_lims$max_value)
  
  print(
    ggplot(GLODAP_CB, aes(
      x = !!sym(i_variable),
      y = !!sym(paste0(i_variable, "_CANYONB"))
    )) +
      geom_bin2d(binwidth = binwidth_value) +
      scale_fill_viridis_c(trans = "log10") +
      geom_abline(slope = 1, col = 'red') +
      coord_equal(xlim = axis_lims,
                  ylim = axis_lims) +
      facet_wrap( ~ basin_AIP) +
      labs(title = "All years")
  ) 
  
  
  # for (i_year in unique(GLODAP_CB$year)) {
  #   # i_year <- 2017
  #   
  #   print(
  #     ggplot(
  #       GLODAP_CB %>% filter(year == i_year),
  #       aes(x = !!sym(i_variable),
  #           y = !!sym(paste0(
  #             i_variable, "_CANYONB"
  #           )))
  #     ) +
  #       geom_bin2d(binwidth = binwidth_value) +
  #       scale_fill_viridis_c(trans = "log10") +
  #       geom_abline(slope = 1, col = 'red') +
  #       coord_equal(xlim = axis_lims,
  #                   ylim = axis_lims) +
  #       facet_wrap( ~ basin_AIP) +
  #       labs(title = paste("Year:", i_year))
  #   )
  # }
  
}



```

## Write files

```{r write_Canyon-B_data_file}

GLODAP_CB %>% 
  select(row_number,
         talk_CANYONB, tco2_CANYONB,
         nitrate_CANYONB, phosphate_CANYONB, silicate_CANYONB) %>% 
  write_csv(paste(path_preprocessing,
                             "GLODAPv2.2021_Canyon-B.csv",
                             sep = ""))

```

# Crossover data


```{r read_Canyon-B_data_file}

GLODAP_CB <-
  read_csv(paste(path_preprocessing,
                 "GLODAPv2.2021_Canyon-B.csv",
                 sep = ""))

```

```{r define_cruises_to_check}

cruises_phosphate_gap_fill <-
  c("33MW19930704",
    "33RO20030604",
    "33RO20050111",
    "33RO19980123")

cruises_talk_gap_fill <-
  c("06AQ19980328")

cruises_tco2_calc <-
  c("35TH20040604",
    "29AH20160617")

cruises_talk_calc <-
  c("06MT19900123",
    "316N19920502",
    "316N19921006")


```





```{r prepare_additional_crossover_data}

xover_add_decade <- glodapv2_2021_xover_add %>%
  mutate(dateA = ymd(str_sub(cruise_A, 5, 12)),
         dateB = ymd(str_sub(cruise_B, 5, 12))) %>%
  mutate(decade = cut(
    year(dateB),
    c(1989, 1999, 2009, 2019),
    labels = c("1989-1999", "2000-2009", "2010-2019")
  )) %>%
  filter(!is.na(decade),
         !is.na(offset)) %>%
  arrange(dateB)

xover_add_decade %>%
  group_by(parameter, cruise_A) %>%
  summarise(offset_mean = mean(offset, na.rm = TRUE)) %>%
  ungroup() %>%
  kable(caption = "Long-term average per cruise and parameter") %>%
  kable_styling() %>%
  scroll_box(height = "250px")


xover_add_decade %>%
  group_by(parameter, decade, cruise_A) %>%
  summarise(offset_mean = mean(offset, na.rm = TRUE)) %>%
  ungroup() %>%
  kable(caption = "Decadal average per cruise and parameter") %>%
  kable_styling() %>%
  scroll_box(height = "250px")

xover_add_decade %>%
  filter(cruise_A %in% cruises_talk_calc,
         parameter == "talk") %>% 
  group_by(parameter, decade, cruise_A) %>%
  summarise(offset_mean = mean(offset, na.rm = TRUE)) %>%
  ungroup() %>%
  kable(caption = "Decadal talk average per cruise") %>%
  kable_styling() %>%
  scroll_box(height = "250px")

xover_add_decade %>%
  filter(cruise_A %in% cruises_talk_calc,
         parameter == "talk") %>% 
  group_by(parameter, decade) %>%
  summarise(offset_mean = mean(offset, na.rm = TRUE)) %>%
  ungroup() %>%
  kable(caption = "Decadal talk average") %>%
  kable_styling() %>%
  scroll_box(height = "250px")

xover_add_decade %>%
  filter(cruise_A %in% cruises_talk_calc,
         parameter == "talk") %>% 
  group_by(parameter) %>%
  summarise(offset_mean = mean(offset, na.rm = TRUE)) %>%
  ungroup() %>%
  kable(caption = "talk average") %>%
  kable_styling() %>%
  scroll_box(height = "250px")

xover_add_decade %>%
  filter(cruise_A %in% cruises_talk_calc,
         parameter == "talk") %>% 
  group_by(parameter, cruise_A) %>%
  summarise(offset_mean = mean(offset, na.rm = TRUE)) %>%
  ungroup() %>%
  kable(caption = "talk average per cruise") %>%
  kable_styling() %>%
  scroll_box(height = "250px")



hline_intercept <- hline_intercept %>% 
  filter(parameter %in% unique(xover_add_decade$parameter))


p_crossover_ts <- xover_add_decade %>%
  ggplot(aes(dateB, offset)) +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Set1") +
  facet_grid(parameter ~ ., scales = "free_y") +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    axis.title.x = element_blank()
  )

p_crossover_decadal <-
  ggplot() +
  geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
  geom_violin(data = xover_add_decade,
               aes(x = decade, y = offset), fill="gold") +
  geom_boxplot(data = xover_add_decade,
               aes(x = decade, y = offset),
               width = 0.2) +
  facet_grid(parameter ~ ., scales = "free_y") +
  labs(title = "Decadal offsets") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90))


p_crossover_ts + p_crossover_decadal +
  plot_layout(widths = c(2, 1))

```



## Gap filling


```{r CANYON-B_gap_filling}

GLODAP <- left_join(GLODAP,
                    GLODAP_CB %>% 
                      select(row_number, ends_with("_CANYONB")))

# fill missing phosphate with CANYON-B estimate

GLODAP_phosphate_fill <- GLODAP %>%
  filter(cruise_expocode %in% cruises_phosphate_gap_fill,
         is.na(phosphate),
         oxygenqc == 1)

GLODAP_phosphate_fill <- GLODAP_phosphate_fill %>% 
  mutate(phosphate = phosphate_CANYONB) %>% 
  filter(!is.na(phosphate))

map +
  geom_tile(data = GLODAP_phosphate_fill %>%
              distinct(lon, lat, cruise_expocode),
            aes(lon, lat, fill = cruise_expocode)) +
  scale_fill_brewer(palette = "Set1")



for (i_cruise in cruises_phosphate_gap_fill) {
  # i_cruise <- cruises_phosphate_gap_fill[1]
  
  p_crossover_ts <- xover_add_decade %>%
    filter(cruise_A %in% i_cruise) %>%
    ggplot(aes(dateB, offset)) +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_point(shape = 21) +
    scale_color_brewer(palette = "Set1") +
    facet_grid(parameter ~ ., scales = "free_y") +
    labs(title = i_cruise) +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical",
      axis.title.x = element_blank()
    )
  
  p_crossover_decadal <-
    ggplot() +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_violin(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      fill = "gold"
    ) +
    geom_boxplot(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      width = 0.2
    ) +
    facet_grid(parameter ~ ., scales = "free_y") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 90))
  
  print(
  p_crossover_ts + p_crossover_decadal +
    plot_layout(widths = c(2, 1))
  )
  
}

# fill missing talk with CANYON-B estimate

GLODAP_talk_fill <- GLODAP %>%
  filter(cruise_expocode %in% cruises_talk_gap_fill,
         is.na(talk),
         oxygenqc == 1)

GLODAP_talk_fill <- GLODAP_talk_fill %>% 
  mutate(talk = talk_CANYONB) %>% 
  filter(!is.na(talk))


map +
  geom_tile(data = GLODAP_talk_fill %>%
              distinct(lon, lat, cruise_expocode),
            aes(lon, lat, fill = cruise_expocode)) +
  scale_fill_brewer(palette = "Set1")



for (i_cruise in cruises_talk_gap_fill) {
  # i_cruise <- cruises_phosphate_gap_fill[1]
  
  p_crossover_ts <- xover_add_decade %>%
    filter(cruise_A %in% i_cruise) %>%
    ggplot(aes(dateB, offset)) +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_point(shape = 21) +
    scale_color_brewer(palette = "Set1") +
    facet_grid(parameter ~ ., scales = "free_y") +
    labs(title = i_cruise) +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical",
      axis.title.x = element_blank()
    )
  
  p_crossover_decadal <-
    ggplot() +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_violin(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      fill = "gold"
    ) +
    geom_boxplot(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      width = 0.2
    ) +
    facet_grid(parameter ~ ., scales = "free_y") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 90))
  
  print(p_crossover_ts + p_crossover_decadal +
          plot_layout(widths = c(2, 1)))
  
}


GLODAP_gap_fill <- bind_rows(
  GLODAP_phosphate_fill,
  GLODAP_talk_fill
)

```

## Flagging

```{r flagged_cruises}


GLODAP_tco2_calc <- GLODAP %>% 
  filter(cruise_expocode %in% cruises_tco2_calc,
         tco2f == 0)


map +
  geom_tile(data = GLODAP_tco2_calc %>%
              distinct(lon, lat, cruise_expocode),
            aes(lon, lat, fill = cruise_expocode)) +
  scale_fill_brewer(palette = "Set1")



for (i_cruise in cruises_tco2_calc) {
  # i_cruise <- cruises_phosphate_gap_fill[1]
  
  p_crossover_ts <- xover_add_decade %>%
    filter(cruise_A %in% i_cruise) %>%
    ggplot(aes(dateB, offset)) +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_point(shape = 21) +
    scale_color_brewer(palette = "Set1") +
    facet_grid(parameter ~ ., scales = "free_y") +
    labs(title = i_cruise) +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical",
      axis.title.x = element_blank()
    )
  
  p_crossover_decadal <-
    ggplot() +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_violin(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      fill = "gold"
    ) +
    geom_boxplot(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      width = 0.2
    ) +
    facet_grid(parameter ~ ., scales = "free_y") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 90))
  
  print(p_crossover_ts + p_crossover_decadal +
          plot_layout(widths = c(2, 1)))
  
}


GLODAP_talk_calc <- GLODAP %>% 
  filter(cruise_expocode %in% cruises_talk_calc,
         talkf == 0)


map +
  geom_tile(data = GLODAP_talk_calc %>%
              distinct(lon, lat, cruise_expocode),
            aes(lon, lat, fill = cruise_expocode)) +
  scale_fill_brewer(palette = "Set1")



for (i_cruise in cruises_talk_calc) {
  # i_cruise <- cruises_phosphate_gap_fill[1]
  
  p_crossover_ts <- xover_add_decade %>%
    filter(cruise_A %in% i_cruise) %>%
    ggplot(aes(dateB, offset)) +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_point(shape = 21) +
    scale_color_brewer(palette = "Set1") +
    facet_grid(parameter ~ ., scales = "free_y") +
    labs(title = i_cruise) +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical",
      axis.title.x = element_blank()
    )
  
  p_crossover_decadal <-
    ggplot() +
    geom_hline(data = hline_intercept, aes(yintercept = intercept)) +
    geom_violin(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      fill = "gold"
    ) +
    geom_boxplot(
      data = xover_add_decade %>%
        filter(cruise_A %in% i_cruise),
      aes(x = decade, y = offset),
      width = 0.2
    ) +
    facet_grid(parameter ~ ., scales = "free_y") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 90))
  
  print(
  p_crossover_ts + p_crossover_decadal +
    plot_layout(widths = c(2, 1))
  )
    
}


GLODAP_calc <- bind_rows(
  GLODAP_tco2_calc,
  GLODAP_talk_calc
)

  
```

## Write files

```{r write_files_for_crossover}

GLODAP_crossover <- bind_rows(
  GLODAP_gap_fill,
  GLODAP_calc
) 

GLODAP_crossover_write <- GLODAP_crossover %>% 
  select(
    EXPOCODE = cruise_expocode,
    STNNBR = station,
    CASTNO = cast,
    BTLNBR = bottle,
    DATE = date,
    LATITUDE = lat,
    LONGITUDE = lon,
    CTDPRS = pressure,
    CTDTMP = temp,
    CTDSAL = sal,
    CTDSAL_FLAG_W = salinityf,
    PHSPHT = phosphate,
    PHSPHT_FLAG_W = phosphatef,
    TCARBN = tco2,
    TCARBN_FLAG_W = tco2f,
    ALKALI = talk,
    ALKALI_FLAG_W = talkf)

GLODAP_crossover_write <- GLODAP_crossover_write %>% 
  mutate(DATE = format(DATE,  "%Y%m%d"))


last_line <- "END_DATA"

for (i_EXPOCODE in unique(GLODAP_crossover_write$EXPOCODE)) {
  # i_EXPOCODE <- unique(GLODAP_crossover_write$EXPOCODE)[1]
  
  temp <- GLODAP_crossover_write %>%
    filter(EXPOCODE == i_EXPOCODE) %>%
    add_row(.before = 1)
  
  cat("Bottle",
      "\n",
      file = paste0(
        path_preprocessing,
        "crossover_cruises/",
        i_EXPOCODE,
        ".exc.csv"
      )
    )
  
  temp %>%
    write_csv(
      file = paste0(
        path_preprocessing,
        "crossover_cruises/",
        i_EXPOCODE,
        ".exc.csv"
      ),
      na = "",
      append = TRUE,
      col_names = TRUE
    )
  
  write(
    last_line,
    file = paste0(
      path_preprocessing,
      "crossover_cruises/",
      i_EXPOCODE,
      ".exc.csv"
    ),
    append = TRUE
  )
  
  
}





```


