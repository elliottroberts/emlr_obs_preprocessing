---
title: "GLODAPv2_2016: Mapped Climatologies"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths, include=FALSE}
path_OceanSODA   <- "/nfs/kryo/work/updata/pco2_OceanSODA-ETHZ/"
path_preprocessing    <- paste(path_root, "/observations/preprocessing/", sep = "")
```

```{r load_libraries_specific, include=FALSE}
library(tidync)
library(lubridate)
library(marelac)
library(broom)
```

# Read source files


```{r prepare_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)


```



```{r read_OceanSODA}

OceanSODA <-
  tidync(paste(
    path_OceanSODA,
    "OceanSODA-ETHZ_1985-2019_v2020b.nc",
    sep = ""
  ))

OceanSODA <- OceanSODA %>% hyper_tibble()

OceanSODA <- OceanSODA %>%
  mutate(date = as.Date(time, origin = '1985-01-01'),
         year = year(date))

OceanSODA <- OceanSODA %>%
  select(year, lat, lon,
         sal = salinity, temp = temperature,
         tco2 = DIC, talk = TA, 
         rev_fac = revelle_factor,
         pCO2)

OceanSODA <- OceanSODA %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

OceanSODA <- inner_join(OceanSODA, basinmask)

```

```{r prep_OceanSODA}

# calculate annual averaged fields
OceanSODA_annual <- OceanSODA %>%
  mutate(tco2_over_pCO2 = tco2/pCO2) %>% 
  group_by(year, lat, lon) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>% 
  ungroup()

# grid data in space and time, remove data outside grid
OceanSODA_annual <- OceanSODA_annual %>%
  mutate(
    grid_area = earth_surf(lat = lat),
    lat_bands = cut(lat, seq(-80, 80, 20)),
    decade = cut(year,
                 seq(1990, 2020, 10),
                 right = FALSE,
                 labels = c("1990-1999", "2000-2009", "2010-2019"))
  ) %>%
  drop_na()


# calculate climatological fields
OceanSODA_clim <- OceanSODA_annual %>%
  select(-c(year, grid_area)) %>% 
  group_by(lat, lon) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE) %>% 
  ungroup()


# calculate area-weighted annual mean within latitude band 
OceanSODA_annual_lat <- OceanSODA_annual %>%
  pivot_longer(sal:tco2_over_pCO2,
               names_to = "parameter",
               values_to = "value") %>%
  mutate(value_area = value * grid_area) %>% 
  group_by(year, lat_bands, decade, parameter) %>%
  summarise(
    area_total = sum(grid_area),
    value_area_total = sum(value_area),
    value_area_ave = value_area_total / area_total
  ) %>%
  ungroup() %>% 
  select(-c(area_total,value_area_total))


# fit decadel linear trends per latitude band
OceanSODA_annual_lat_trend <- OceanSODA_annual_lat %>% 
  nest(data = -c(decade, lat_bands, parameter)) %>% 
  mutate(tidy = map(data,
                    ~tidy(lm(value_area_ave ~ year, data = .x)))) %>% 
  select(-data) %>% 
  unnest(tidy)


# calculate area-weighted annual mean globally
OceanSODA_annual_glob <- OceanSODA_annual %>%
  pivot_longer(sal:tco2_over_pCO2,
               names_to = "parameter",
               values_to = "value") %>%
  mutate(value_area = value * grid_area) %>% 
  group_by(year, decade, parameter) %>%
  summarise(
    area_total = sum(grid_area),
    value_area_total = sum(value_area),
    value_area_ave = value_area_total / area_total
  ) %>%
  ungroup() %>% 
  select(-c(area_total,value_area_total))


# fit decadel linear trends globally
OceanSODA_annual_glob_trend <- OceanSODA_annual_glob %>% 
  nest(data = -c(decade, parameter)) %>% 
  mutate(tidy = map(data,
                    ~tidy(lm(value_area_ave ~ year, data = .x)))) %>% 
  select(-data) %>% 
  unnest(tidy)


```

## Control plots

```{r OceanSODA_control_plots, fig.asp=0.5}

map +
  geom_raster(data = OceanSODA_annual %>%
                filter(year == 2010), aes(lon, lat, fill = lat_bands)) +
  scale_fill_brewer(palette = "Spectral") +
  labs(title = "Year: 2010")

map +
  geom_raster(data = OceanSODA_annual %>%
                filter(year == 2010), aes(lon, lat, fill = grid_area)) +
  scale_fill_viridis_c() +
  labs(title = "Year: 2010")


```


# Climatology map

```{r rev_fac_climatology_maps, fig.asp=0.5}

OceanSODA_clim %>%
  pivot_longer(sal:tco2_over_pCO2,
               names_to = "parameter",
               values_to = "value") %>%
  group_split(parameter) %>%
  # head(1) %>% 
  map( ~ map +
         geom_raster(data = .x,
                     aes(lon, lat, fill = value)) +
         scale_fill_viridis_c(name = .x$parameter))


```

# Time series

```{r time_series}

OceanSODA_annual_lat %>%
  group_split(parameter) %>%
  # head(1) %>% 
  map(
    ~ ggplot(data = .x,
             aes(year, value_area_ave, col = lat_bands)) +
      scale_color_brewer(palette = "Spectral") +
      geom_path() +
      geom_point() +
      labs(y = .x$parameter)
  )

```

# Decadel trends

## Global

```{r decadel_trends_glob, fig.asp=0.5}

OceanSODA_annual_glob %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, value_area_ave, col = decade)) +
      scale_color_brewer(palette = "Set1") +
      geom_point() +
      labs(y = .x$parameter) +
      geom_smooth(method = "lm", se = FALSE)
  )


OceanSODA_annual_glob_trend %>%
  filter(term == "year") %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decade, estimate)) +
      scale_fill_brewer(palette = "Spectral") +
      geom_point(shape = 21) +
      geom_path() +
      labs(y = paste(.x$parameter, "annual change"))
  )

```


## Latitude bands

```{r decadel_trends_lat, fig.asp=0.5}

OceanSODA_annual_lat %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, value_area_ave, col = decade)) +
      scale_color_brewer(palette = "Set1") +
      geom_point() +
      labs(y = .x$parameter) +
      geom_smooth(method = "lm", se = FALSE) +
      facet_wrap( ~ lat_bands)
  )


OceanSODA_annual_lat_trend %>%
  filter(term == "year") %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(decade, estimate, fill = lat_bands)) +
      scale_fill_brewer(palette = "Spectral") +
      geom_point(shape = 21) +
      geom_path() +
      labs(y = paste(.x$parameter, "annual change"))
  )

```


